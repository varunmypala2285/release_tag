name: Auto Tag and Release (test/PROD only)

on:
  pull_request:
    types: [closed]
    branches:
      - test/PROD

jobs:
  create-release:
    if: >
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.title, 'Sprint Release:')
    runs-on: ubuntu-latest
    env:
      TARGET_BRANCH: "test/PROD"
      GITHUB_API: "https://api.github.com"
      REPO: ${{ github.repository }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # fetch all history and tags

      - name: Set up Git config
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          echo "Previous tag: $PREV_TAG"
          echo "prev_tag=$PREV_TAG" >> $GITHUB_OUTPUT

      - name: Determine next sprint tag
        id: next_tag
        run: |
          PREV=${{ steps.prev_tag.outputs.prev_tag }}
          if [ -z "$PREV" ]; then
            NEXT_TAG="sprint_1"
          else
            NUM=$(echo $PREV | grep -oE '[0-9]+$' || echo "0")
            NEXT_NUM=$((NUM + 1))
            NEXT_TAG="sprint_${NEXT_NUM}"
          fi
          echo "Next tag: $NEXT_TAG"
          echo "next_tag=$NEXT_TAG" >> $GITHUB_OUTPUT

      - name: Get latest commit SHA from test/PROD
        id: sha
        run: |
          LATEST_SHA=$(git rev-parse origin/test/PROD)
          echo "Latest commit on test/PROD: $LATEST_SHA"
          echo "sha=$LATEST_SHA" >> $GITHUB_OUTPUT

      - name: Create GitHub release via REST API
        env:
          GITHUB_TOKEN: ${{ secrets.VARUN2_TOKEN }}
        run: |
          OWNER=$(echo "$REPO" | cut -d'/' -f1)
          REPO_NAME=$(echo "$REPO" | cut -d'/' -f2)
          TAG_NAME=${{ steps.next_tag.outputs.next_tag }}
          TARGET_COMMITISH=${{ steps.sha.outputs.sha }}
          echo "Creating release for $TAG_NAME at $TARGET_COMMITISH"

          API_URL="https://api.github.com/repos/${{ github.repository }}/releases"
          BODY=$(jq -n \
            --arg tag "$TAG_NAME" \
            --arg target "$TARGET_COMMITISH" \
            '{tag_name: $tag, target_commitish: $target, generate_release_notes: true, name: $tag}')
          
          curl -s -w "\n%{http_code}" -X POST "https://api.github.com/repos/${OWNER}/${REPO_NAME}/releases" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            -d "$BODY"
