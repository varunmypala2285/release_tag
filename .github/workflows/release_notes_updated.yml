name: Auto Tag and Clean Release Notes (PROD)

on:
  pull_request:
    types: [closed]
    branches:
      - test/PROD

permissions:
  contents: write

jobs:
  create_release:
    if: |
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.title, 'Sprint Release:')
    runs-on: ubuntu-latest

    env:
      TARGET_BRANCH: "test/PROD"
      GITHUB_API: "https://api.github.com"
      REPO: ${{ github.repository }}

    steps:
      # 1. Clone repository
      - name: Clone repository
        env:
          TOKEN: ${{ secrets.SUNIL3 }}
        run: |
          echo "Cloning repository..."
          git clone https://x-access-token:${TOKEN}@github.com/${{ github.repository }} .
          git fetch --tags --prune
          git checkout ${TARGET_BRANCH}
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          echo "Repository cloned and configured."

      # 2. Determine next sprint tag
      - name: Compute next sprint tag
        id: sprint
        run: |
          LAST=$(git tag --list "sprint_*" | sort -V | tail -n1)
          if [ -z "$LAST" ]; then
             NEXT="sprint_1"
          else
             NUM=$(echo "$LAST" | grep -oE '[0-9]+$')
             NEXT="sprint_$((NUM+1))"
          fi
          echo "last_tag=$LAST" >> $GITHUB_OUTPUT
          echo "new_tag=$NEXT" >> $GITHUB_OUTPUT
          echo "Last Tag: $LAST | Next Tag: $NEXT"

      # 3. Collect only valid merge commits (â†’ test/PROD)
      - name: Collect commits for release notes
        id: commits
        run: |
          LAST="${{ steps.sprint.outputs.last_tag }}"
          if [ -z "$LAST" ]; then
            RANGE="HEAD"
          else
            RANGE="${LAST}..HEAD"
          fi

          echo "Collecting commits from $RANGE ..."
          echo "**What's Changed**" > commits.txt
          echo "" >> commits.txt

          git log $RANGE --pretty=format:"%H" | while read COMMIT; do
            SUBJECT=$(git log -1 --pretty=format:"%s" $COMMIT)
            BODY=$(git log -1 --pretty=format:"%b" $COMMIT)

            # Include only merges into test/PROD
            if echo "$SUBJECT" | grep -iq "merge pull request" && echo "$BODY" | grep -iq "to test/PROD"; then
              FORMATTED=$(echo "$SUBJECT" | sed -E 's|(merge pull request #[0-9]+.*from )([^/]+)/(.*)|\1@\2/\3|I')
              echo "$FORMATTED" >> commits.txt

              TITLE=$(echo "$BODY" | head -n 1)
              if [ -n "$TITLE" ]; then
                echo "  - $TITLE" >> commits.txt
              fi
              echo "" >> commits.txt
            fi
          done

          echo "Final commits.txt content:"
          cat commits.txt

      # 4. Create and push new tag
      - name: Create and push new tag
        env:
          TOKEN: ${{ secrets.SUNIL3 }}
        run: |
          TAG=${{ steps.sprint.outputs.new_tag }}
          HEAD_SHA=$(git rev-parse ${TARGET_BRANCH})
          git tag -a "$TAG" "$HEAD_SHA" -m "Sprint Release $TAG"
          git push https://x-access-token:${TOKEN}@github.com/${{ github.repository }}.git "refs/tags/$TAG"
          echo "Tag $TAG created and pushed successfully."

      # 5. Create GitHub Release manually
      - name: Create GitHub Release
        env:
          TOKEN: ${{ secrets.SUNIL3 }}
          TAG: ${{ steps.sprint.outputs.new_tag }}
          TARGET_BRANCH: ${{ env.TARGET_BRANCH }}
          REPO: ${{ github.repository }}
        run: |
          OWNER=$(echo "$REPO" | cut -d'/' -f1)
          REPO_NAME=$(echo "$REPO" | cut -d'/' -f2)
          BODY=$(cat commits.txt | sed 's/"/\\"/g' | sed ':a;N;$!ba;s/\n/\\n/g')

          echo "Creating release for tag $TAG..."
          curl -s -X POST "https://api.github.com/repos/${OWNER}/${REPO_NAME}/releases" \
            -H "Authorization: Bearer ${TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            -d "{
              \"tag_name\": \"${TAG}\",
              \"target_commitish\": \"${TARGET_BRANCH}\",
              \"name\": \"Sprint Release ${TAG}\",
              \"body\": \"${BODY}\",
              \"draft\": false,
              \"prerelease\": false
            }"

          echo "Release created successfully."
